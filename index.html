<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sport Performance Pose Estimation</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .participant-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        input, select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .video-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }
        
        video, canvas {
            width: 100%;
            height: auto;
            display: block;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .metrics-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .metric-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
        }
        
        .metric-unit {
            font-size: 0.8em;
            color: #999;
        }
        
        .participants-list {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .participant-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .participant-info {
            flex: 1;
        }
        
        .fps-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-info {
            background: #dbeafe;
            color: #1e40af;
        }

        @media (max-width: 768px) {
            .video-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÉ‚Äç‚ôÇÔ∏è Sport Performance Analyzer</h1>
        <p class="subtitle">High-Speed Motion Capture & Biomechanics Analysis</p>
        
        <div class="participant-form">
            <h3>Participant Information</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="participantName">Name *</label>
                    <input type="text" id="participantName" placeholder="Enter name" required>
                </div>
                <div class="form-group">
                    <label for="participantSex">Sex *</label>
                    <select id="participantSex" required>
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="participantAge">Age (years) *</label>
                    <input type="number" id="participantAge" min="5" max="120" placeholder="Age" required>
                </div>
                <div class="form-group">
                    <label for="participantMass">Mass (kg) *</label>
                    <input type="number" id="participantMass" min="20" max="300" step="0.1" placeholder="Weight" required>
                </div>
                <div class="form-group">
                    <label for="participantHeight">Height (cm) *</label>
                    <input type="number" id="participantHeight" min="50" max="250" step="0.1" placeholder="Height" required>
                </div>
            </div>
            <button class="btn btn-success" onclick="addParticipant()">Add Participant</button>
        </div>

        <div id="statusMessage"></div>

        <div class="video-section">
            <div class="video-container">
                <video id="video" playsinline></video>
                <canvas id="canvas"></canvas>
                <div class="fps-indicator" id="fpsIndicator">FPS: 0</div>
            </div>
            <div>
                <h3>Select Participant for Recording</h3>
                <select id="selectedParticipant" class="form-group" style="width: 100%; margin-bottom: 10px;">
                    <option value="">Select a participant</option>
                </select>
                <div class="form-group">
                    <label for="fpsSelection">Video Frame Rate</label>
                    <select id="fpsSelection">
                        <option value="30">30 FPS (Standard)</option>
                        <option value="60">60 FPS (High)</option>
                        <option value="120">120 FPS (Very High)</option>
                        <option value="240">240 FPS (Ultra High)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="startCamera()">Start Camera</button>
            <button class="btn btn-success" onclick="startRecording()" id="recordBtn" disabled>Start Recording</button>
            <button class="btn btn-danger" onclick="stopRecording()" id="stopBtn" disabled>Stop Recording</button>
            <button class="btn btn-primary" onclick="stopCamera()">Stop Camera</button>
        </div>

        <div class="metrics-panel">
            <h3>Real-Time Biomechanics</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">Linear Displacement</div>
                    <div class="metric-value" id="displacement">0.00<span class="metric-unit"> m</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Linear Velocity</div>
                    <div class="metric-value" id="velocity">0.00<span class="metric-unit"> m/s</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Knee Angle (Right)</div>
                    <div class="metric-value" id="kneeAngle">0<span class="metric-unit">¬∞</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Elbow Angle (Right)</div>
                    <div class="metric-value" id="elbowAngle">0<span class="metric-unit">¬∞</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Hip Angle (Right)</div>
                    <div class="metric-value" id="hipAngle">0<span class="metric-unit">¬∞</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">Angular Velocity</div>
                    <div class="metric-value" id="angularVelocity">0<span class="metric-unit">¬∞/s</span></div>
                </div>
            </div>
        </div>

        <div class="participants-list">
            <h3>Participants (<span id="participantCount">0</span>/10)</h3>
            <div id="participantsList"></div>
            <button class="btn btn-primary" onclick="downloadData()" style="margin-top: 15px;">üìä Download All Data (XLSX)</button>
        </div>
    </div>

    <script>
        let detector;
        let video;
        let canvas;
        let ctx;
        let animationId;
        let isRecording = false;
        let recordingData = [];
        let previousPose = null;
        let previousTime = null;
        let participants = [];
        let currentParticipant = null;
        let detectedFPS = 0;
        let frameCount = 0;
        let lastFPSUpdate = Date.now();

        async function initializePoseDetection() {
            const model = window.poseDetection.SupportedModels.MoveNet;
            detector = await window.poseDetection.createDetector(model, {
                modelType: window.poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
            });
        }

        async function startCamera() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            const fps = parseInt(document.getElementById('fpsSelection').value);
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: fps }
                    }
                });
                
                video.srcObject = stream;
                await video.play();
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                if (!detector) {
                    showStatus('Initializing AI model...', 'info');
                    await initializePoseDetection();
                    showStatus('AI model loaded successfully!', 'success');
                }
                
                document.getElementById('recordBtn').disabled = false;
                detectPose();
            } catch (err) {
                showStatus('Error accessing camera: ' + err.message, 'error');
            }
        }

        function stopCamera() {
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                if (animationId) cancelAnimationFrame(animationId);
                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                isRecording = false;
            }
        }

        async function detectPose() {
            if (!video || video.readyState !== 4) {
                animationId = requestAnimationFrame(detectPose);
                return;
            }

            const poses = await detector.estimatePoses(video);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (poses.length > 0) {
                const pose = poses[0];
                drawSkeleton(pose.keypoints);
                calculateMetrics(pose.keypoints);
                
                if (isRecording && currentParticipant) {
                    recordFrame(pose.keypoints);
                }
            }
            
            updateFPS();
            animationId = requestAnimationFrame(detectPose);
        }

        function drawSkeleton(keypoints) {
            const connections = [
                [5, 6], [5, 7], [7, 9], [6, 8], [8, 10],
                [5, 11], [6, 12], [11, 12],
                [11, 13], [13, 15], [12, 14], [14, 16]
            ];

            keypoints.forEach(kp => {
                if (kp.score > 0.3) {
                    ctx.beginPath();
                    ctx.arc(kp.x, kp.y, 5, 0, 2 * Math.PI);
                    ctx.fillStyle = '#00ff00';
                    ctx.fill();
                }
            });

            connections.forEach(([i, j]) => {
                const kp1 = keypoints[i];
                const kp2 = keypoints[j];
                if (kp1.score > 0.3 && kp2.score > 0.3) {
                    ctx.beginPath();
                    ctx.moveTo(kp1.x, kp1.y);
                    ctx.lineTo(kp2.x, kp2.y);
                    ctx.strokeStyle = '#ff0000';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
        }

        function calculateAngle(p1, p2, p3) {
            const rad = Math.atan2(p3.y - p2.y, p3.x - p2.x) - 
                        Math.atan2(p1.y - p2.y, p1.x - p2.x);
            let angle = Math.abs(rad * 180 / Math.PI);
            if (angle > 180) angle = 360 - angle;
            return Math.round(angle);
        }

        function calculateDistance(p1, p2) {
            return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
        }

        function calculateMetrics(keypoints) {
            const hip = keypoints[12];
            const knee = keypoints[14];
            const ankle = keypoints[16];
            const shoulder = keypoints[6];
            const elbow = keypoints[8];
            const wrist = keypoints[10];

            if (knee.score > 0.3 && hip.score > 0.3 && ankle.score > 0.3) {
                const kneeAngle = calculateAngle(hip, knee, ankle);
                document.getElementById('kneeAngle').innerHTML = 
                    kneeAngle + '<span class="metric-unit">¬∞</span>';
            }

            if (shoulder.score > 0.3 && elbow.score > 0.3 && wrist.score > 0.3) {
                const elbowAngle = calculateAngle(shoulder, elbow, wrist);
                document.getElementById('elbowAngle').innerHTML = 
                    elbowAngle + '<span class="metric-unit">¬∞</span>';
            }

            const leftHip = keypoints[11];
            const rightHip = keypoints[12];
            const leftShoulder = keypoints[5];
            
            if (leftHip.score > 0.3 && rightHip.score > 0.3 && leftShoulder.score > 0.3) {
                const hipAngle = calculateAngle(leftShoulder, leftHip, knee);
                document.getElementById('hipAngle').innerHTML = 
                    hipAngle + '<span class="metric-unit">¬∞</span>';
            }

            const currentTime = Date.now() / 1000;
            if (previousPose && previousTime) {
                const dt = currentTime - previousTime;
                
                const pixelsToMeters = currentParticipant ? 
                    (currentParticipant.height / 100) / canvas.height : 0.002;
                
                const centerPrev = previousPose[0];
                const centerCurr = hip;
                
                if (centerPrev && centerCurr.score > 0.3) {
                    const dx = (centerCurr.x - centerPrev.x) * pixelsToMeters;
                    const dy = (centerCurr.y - centerPrev.y) * pixelsToMeters;
                    const displacement = Math.sqrt(dx * dx + dy * dy);
                    const velocity = dt > 0 ? displacement / dt : 0;
                    
                    document.getElementById('displacement').innerHTML = 
                        displacement.toFixed(2) + '<span class="metric-unit"> m</span>';
                    document.getElementById('velocity').innerHTML = 
                        velocity.toFixed(2) + '<span class="metric-unit"> m/s</span>';
                }

                if (previousPose[14] && knee.score > 0.3) {
                    const prevAngle = calculateAngle(previousPose[12], previousPose[14], previousPose[16]);
                    const currAngle = calculateAngle(hip, knee, ankle);
                    const angularVel = dt > 0 ? (currAngle - prevAngle) / dt : 0;
                    
                    document.getElementById('angularVelocity').innerHTML = 
                        Math.abs(angularVel).toFixed(1) + '<span class="metric-unit">¬∞/s</span>';
                }
            }
            
            previousPose = keypoints;
            previousTime = currentTime;
        }

        function updateFPS() {
            frameCount++;
            const now = Date.now();
            if (now - lastFPSUpdate >= 1000) {
                detectedFPS = frameCount;
                document.getElementById('fpsIndicator').textContent = `FPS: ${detectedFPS}`;
                frameCount = 0;
                lastFPSUpdate = now;
            }
        }

        function addParticipant() {
            if (participants.length >= 10) {
                showStatus('Maximum 10 participants reached!', 'error');
                return;
            }

            const name = document.getElementById('participantName').value.trim();
            const sex = document.getElementById('participantSex').value;
            const age = document.getElementById('participantAge').value;
            const mass = document.getElementById('participantMass').value;
            const height = document.getElementById('participantHeight').value;

            if (!name || !sex || !age || !mass || !height) {
                showStatus('Please fill in all participant information!', 'error');
                return;
            }

            const participant = {
                id: Date.now(),
                name, sex, age: parseInt(age), 
                mass: parseFloat(mass), 
                height: parseFloat(height),
                recordings: []
            };

            participants.push(participant);
            updateParticipantsList();
            clearParticipantForm();
            showStatus(`Participant "${name}" added successfully!`, 'success');
        }

        function clearParticipantForm() {
            document.getElementById('participantName').value = '';
            document.getElementById('participantSex').value = '';
            document.getElementById('participantAge').value = '';
            document.getElementById('participantMass').value = '';
            document.getElementById('participantHeight').value = '';
        }

        function updateParticipantsList() {
            const list = document.getElementById('participantsList');
            const select = document.getElementById('selectedParticipant');
            
            document.getElementById('participantCount').textContent = participants.length;
            
            list.innerHTML = participants.map(p => `
                <div class="participant-item">
                    <div class="participant-info">
                        <strong>${p.name}</strong> - ${p.sex}, ${p.age}y, ${p.mass}kg, ${p.height}cm
                        <br><small>Recordings: ${p.recordings.length}</small>
                    </div>
                    <button class="btn btn-danger" onclick="removeParticipant(${p.id})">Remove</button>
                </div>
            `).join('');

            select.innerHTML = '<option value="">Select a participant</option>' +
                participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        function removeParticipant(id) {
            participants = participants.filter(p => p.id !== id);
            updateParticipantsList();
            showStatus('Participant removed', 'info');
        }

        function startRecording() {
            const selectedId = document.getElementById('selectedParticipant').value;
            if (!selectedId) {
                showStatus('Please select a participant first!', 'error');
                return;
            }

            currentParticipant = participants.find(p => p.id == selectedId);
            isRecording = true;
            recordingData = [];
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            showStatus(`Recording for ${currentParticipant.name}...`, 'info');
        }

        function stopRecording() {
            if (isRecording && currentParticipant && recordingData.length > 0) {
                currentParticipant.recordings.push({
                    timestamp: new Date().toISOString(),
                    fps: detectedFPS,
                    data: recordingData
                });
                updateParticipantsList();
                showStatus(`Recording saved! ${recordingData.length} frames captured.`, 'success');
            }
            
            isRecording = false;
            recordingData = [];
            currentParticipant = null;
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        function recordFrame(keypoints) {
            const hip = keypoints[12];
            const knee = keypoints[14];
            const ankle = keypoints[16];
            const shoulder = keypoints[6];
            const elbow = keypoints[8];
            const wrist = keypoints[10];

            recordingData.push({
                timestamp: Date.now(),
                kneeAngle: knee.score > 0.3 ? calculateAngle(hip, knee, ankle) : null,
                elbowAngle: elbow.score > 0.3 ? calculateAngle(shoulder, elbow, wrist) : null,
                hipPosition: hip.score > 0.3 ? { x: hip.x, y: hip.y } : null
            });
        }

        function downloadData() {
            if (participants.length === 0) {
                showStatus('No participants to export!', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();

            participants.forEach(participant => {
                const sheetData = [
                    ['Participant Information'],
                    ['Name', participant.name],
                    ['Sex', participant.sex],
                    ['Age', participant.age],
                    ['Mass (kg)', participant.mass],
                    ['Height (cm)', participant.height],
                    [],
                    ['Recordings', participant.recordings.length]
                ];

                participant.recordings.forEach((recording, idx) => {
                    sheetData.push([]);
                    sheetData.push([`Recording ${idx + 1}`, recording.timestamp]);
                    sheetData.push(['FPS', recording.fps]);
                    sheetData.push(['Frame', 'Timestamp (ms)', 'Knee Angle (¬∞)', 'Elbow Angle (¬∞)', 'Hip X', 'Hip Y']);
                    
                    recording.data.forEach((frame, frameIdx) => {
                        sheetData.push([
                            frameIdx,
                            frame.timestamp,
                            frame.kneeAngle || 'N/A',
                            frame.elbowAngle || 'N/A',
                            frame.hipPosition ? frame.hipPosition.x.toFixed(2) : 'N/A',
                            frame.hipPosition ? frame.hipPosition.y.toFixed(2) : 'N/A'
                        ]);
                    });
                });

                const ws = XLSX.utils.aoa_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, participant.name.substring(0, 31));
            });

            XLSX.writeFile(wb, `sport_performance_data_${new Date().toISOString().split('T')[0]}.xlsx`);
            showStatus('Data exported successfully!', 'success');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        window.addEventListener('load', () => {
            showStatus('Ready to start! Add participants to begin.', 'info');
        });
    </script>
</body>
</html>
